{% load static %}
{% load permission_tags %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SAPE</title>
  
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="{% static 'css/minhas_campanhas.css' %}">
    

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{% static 'plugins/fontawesome-free/css/all.min.css' %}">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="{% static 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
  <!-- iCheck -->
  <link rel="stylesheet" href="{% static 'plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{% static 'plugins/jqvmap/jqvmap.min.css' %}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="{% static 'plugins/overlayScrollbars/css/OverlayScrollbars.min.css' %}">
  
  
  <!-- toastr -->
  <link href="{% static 'plugins/toastr/toastr.min.css' %}" rel="stylesheet"/>
  <!-- summernote -->
  <link rel="stylesheet" href="{% static 'plugins/summernote/summernote-bs4.min.css' %}">
  <link rel="icon" href="{% static  'images/sape-icon.png' %}">

</head>

<body class="hold-transition sidebar-mini layout-fixed">
  <div class="wrapper">
  
    <!-- Preloader -->
    <div class="preloader flex-column justify-content-center align-items-center">
      <img class="animation__shake" src="{% static  'images/sape-icon.png' %}" alt="SAPE-logo" height="60px" width="60px">
    </div>
  
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- Left navbar links -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="/home/" class="nav-link">Home</a>
        </li>
  
      </ul>
  
      <!-- Right navbar links -->
      <ul class="navbar-nav ml-auto">
  
        <!-- Navbar Search -->
        <li class="nav-item">
          <a class="nav-link" data-widget="navbar-search" role="button">
            <i class="fas fa-search"></i>
          </a>
          <div class="navbar-search-block">
            <form class="form-inline">
              <div class="input-group input-group-sm">
                <input id="pesquisar" class="form-control form-control-navbar"  placeholder="Pesquisar" >
                <div class="input-group-append"> 
                  <button id="limpar-input" class="btn btn-navbar" type="button" data-widget="navbar-search">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </li>
        
  
        <!-- fullscreen -->
        <li class="nav-item d-none d-sm-inline-block">
          <a class="nav-link" data-widget="fullscreen" href="#" role="button">
            <i class="fas fa-expand-arrows-alt"></i>
          </a>
        </li>
      </ul> 
  
    </nav>
    <!-- /.navbar -->
  
    <!-- Main Sidebar Container -->
    {% include 'partials/menu_lateral.html' %}
  
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
        <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <div id="title-header">
            <h1 id="title-header" class="m-0">Dashboards</h1>
            </div>
          </div><!-- /.col -->
          
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><button onclick=novo_dashboard() id="cadastrar-campanha" class="btn btn-primary"><svg class="icone-branco" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>&nbsp;&nbsp;Novo Dashboard</button></a></li>             
            </ol>
          </div><!-- /.col -->
         
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
      <!-- /.content-header -->
  
      <!-- Main content -->
      <section class="content">
        <div class="grid-pai">
          <div id="flex-container">
            {% for dashboard in dashboards %}
            <div class="flex-item campanha-{{ dashboard.id }}">
                <a class="item" href="/visualizar_dashboard/{{ dashboard.id }}/">
                    <div class="info">
                        <label>Título</label> 
                        <p id="titulo" class="dado">{{ dashboard.title }}</p>
                        <label>Descrição</label>
                        <p id="descricao" class="dado">{{ dashboard.description }}</p>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
          
        </div>
        <div class="centered-div" id="no-cadastros" style="display: none;">
          <!-- Div centralizada para "Não há cadastros" -->
          <p>Nenhum Dashboard criado.</p>
        </div>
      </section>
    
      <!-- /.content -->
    </div>
    <!-- /version do sistema -->
    {% include 'footer_version.html' %}
  
  </div>
  <!-- ./wrapper -->
  
  <!-- jQuery -->
  <script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <!-- ChartJS -->
  <script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
  <!-- Sparkline -->
  <script src="{% static 'plugins/sparklines/sparkline.js' %}"></script>
  <!-- JQVMap -->
  <script src="{% static 'plugins/jqvmap/jquery.vmap.min.js' %}"></script>
  <script src="{% static 'plugins/jqvmap/maps/jquery.vmap.usa.js' %}"></script>
  <!-- jQuery Knob Chart -->
  <script src="{% static 'plugins/jquery-knob/jquery.knob.min.js' %}"></script>
  <!-- daterangepicker -->
  <script src="{% static 'plugins/moment/moment.min.js' %}"></script>
  <script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
  <!-- Summernote -->
  <script src="{% static 'plugins/summernote/summernote-bs4.min.js' %}"></script>
  <!-- overlayScrollbars -->
  <script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
  <!-- AdminLTE App -->
  <script src="{% static '/dist/js/adminlte.js' %}"></script>
  <!-- Toastr -->
  <script src="{% static 'plugins/toastr/toastr.min.js' %}"></script>


  <!-- Menu Lateral -->
  <script src="{% static 'js/menu_lateral.js' %}"></script>
  <script>
   active_menu_monitoramento()
  </script>
  
  <script src="{% static 'js/filtros.js' %}"></script>
  <script src="{% static 'js/animacao_dropdown.js' %}"></script>
  <script src="{% static 'js/minhas_campanhas.js' %}"></script>
  
<script>
  // Cria o modal apenas uma vez
  function ensureNovoDashboardModal() {
    if (document.getElementById('modalNovoDashboard')) return;

    const modalHtml = `
    <div class="modal fade" id="modalNovoDashboard" tabindex="-1" role="dialog" aria-labelledby="modalNovoDashboardLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalNovoDashboardLabel">Novo Dashboard</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body">
            <form id="formNovoDashboard">
              <div class="form-group">
                <label for="nd_titulo">Título</label>
                <input type="text" class="form-control" id="nd_titulo" placeholder="Ex.: Dashboard - Semana 01 a 07/12">
              </div>

              <div class="form-group">
                <label for="nd_descricao">Descrição</label>
                <textarea class="form-control" id="nd_descricao" rows="3" placeholder="Breve descrição do dashboard"></textarea>
              </div>

              <div class="form-group">
                <label for="nd_initial_date">Data inicial</label>
                <input type="date" class="form-control" id="nd_initial_date">
              </div>

              <div class="form-group">
                <label for="nd_final_date">Data final</label>
                <input type="date" class="form-control" id="nd_final_date">
                <small class="form-text text-muted">
                  O período será usado para gerar os dados deste dashboard.
                </small>
              </div>
            </form>
            <div id="nd_alert" class="alert alert-danger d-none mb-0" role="alert"></div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button id="nd_confirmar" type="button" class="btn btn-primary">
              <i class="fas fa-plus mr-1"></i> Criar Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Handler do botão "Criar Dashboard"
    document.getElementById('nd_confirmar').addEventListener('click', async function () {
      const titulo = document.getElementById('nd_titulo').value.trim();
      const descricao = document.getElementById('nd_descricao').value.trim();
      const initialDate = document.getElementById('nd_initial_date').value;
      const finalDate = document.getElementById('nd_final_date').value;

      const alertBox = document.getElementById('nd_alert');
      const showError = (msg) => { alertBox.textContent = msg; alertBox.classList.remove('d-none'); };
      const hideError = () => { alertBox.textContent = ''; alertBox.classList.add('d-none'); };

      hideError();

      if (!titulo) return showError('Informe o título.');
      if (!descricao) return showError('Informe a descrição.');
      if (!initialDate) return showError('Informe a data inicial.');
      if (!finalDate) return showError('Informe a data final.');

      // initialDate e finalDate vêm no formato YYYY-MM-DD; comparação de string funciona
      if (initialDate > finalDate) {
        return showError('A data inicial não pode ser maior que a data final.');
      }

      // Sanitiza para uso em path e codifica
      const sanitizeForPath = (s) => encodeURIComponent(s.replace(/[\/\\]/g, '-'));
      const nameEnc = sanitizeForPath(titulo);
      const descEnc = sanitizeForPath(descricao);
      const initialEnc = sanitizeForPath(initialDate);
      const finalEnc = sanitizeForPath(finalDate);

      // NOVA ROTA (sugestão):
      // path('novo-dashboard/<str:initial_date>/<str:final_date>/<str:title>/<str:description>/', novo_dashboard, name='novo_dashboard')
      const url = `/novo-dashboard/${initialEnc}/${finalEnc}/${nameEnc}/${descEnc}/`;

      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        });

        if (!resp.ok) {
          let msg = 'Erro ao criar dashboard.';
          try {
            const err = await resp.json();
            if (err && err.detail) msg = err.detail;
          } catch(_) {}
          alert(msg);
          return;
        }

        const data = await resp.json();
        if (data.status === "ok") {
          $('#modalNovoDashboard').modal('hide');
          alert(`${data.title} criado com sucesso.`);
          location.reload();
        } else {
          alert(data.message || "Erro ao criar Dashboard.");
        }
      } catch (error) {
        console.error("Erro:", error);
        alert("Erro na requisição.");
      }
    });
  }

  // Função chamada no botão
  async function novo_dashboard() {
    ensureNovoDashboardModal();
    $('#modalNovoDashboard').modal('show');
    $('#modalNovoDashboard').on('shown.bs.modal', function () {
      document.getElementById('nd_titulo').focus();
    });
  }
</script>



</body>

</html>