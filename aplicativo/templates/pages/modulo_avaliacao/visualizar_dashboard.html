{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SAPE</title>


  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="{% static 'css/visualizar_campanha.css' %}">


  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{% static 'plugins/fontawesome-free/css/all.min.css' %}">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="{% static 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
  <!-- iCheck -->
  <link rel="stylesheet" href="{% static 'plugins/icheck-bootstrap/icheck-bootstrap.min.css' %}">
  <!-- JQVMap -->
  <link rel="stylesheet" href="{% static 'plugins/jqvmap/jqvmap.min.css' %}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="{% static 'plugins/overlayScrollbars/css/OverlayScrollbars.min.css' %}">


  <!-- summernote -->
  <link rel="stylesheet" href="{% static 'plugins/summernote/summernote-bs4.min.css' %}">
  <link rel="icon" href="{% static  'images/sape-icon.png' %}">

</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- Preloader -->
  <div class="preloader flex-column justify-content-center align-items-center">
    <img class="animation__shake" src="{% static  'images/sape-icon.png' %}" alt="SAPE-logo" height="60px" width="60px">
  </div>

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="/noticias/" class="nav-link">Inicio</a>
      </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">

      <!-- fullscreen -->
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>

    </ul>

  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  {% include 'partials/menu_lateral.html' %}

  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <div id="title-header">
            <h1 id="title-header" class="m-0">Visualizar Dashboard</h1>
            </div>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->


    <!-- Main content -->
    <div class="card card-success">
    <div class="card-header">
        <h3 class="card-title">{{ dashboard.title }}</h3>
    </div>
    <div class="card-body">
        <div class="chart">
        <canvas id="barChart" style="min-height:250px;height:550px;max-height:650px;max-width:100%;"></canvas>
        </div>
    </div>
    </div>

    {# Envia oe_count para o JS com segurança #}
    {{ dashboard.oe_count|default:"[]"|json_script:"oeCountData" }}

    <script>
    (function () {
        // 1) Lê a lista do JSONField
        var raw = [];
        try {
        raw = JSON.parse(document.getElementById('oeCountData').textContent || '[]');
        } catch (e) {
        raw = [];
        }

        // 2) Garante 24 posições (idx 0..23 => OE01..OE24)
        var counts = Array.from({length: 25}, function (_, i) {
        var v = Number(raw[i]);
        return Number.isFinite(v) ? v : 0;
        });

        // 3) Labels OE01..OE24
        var labels = Array.from({length: 25}, function (_, i) {
        return 'OE' + String(i + 1).padStart(2, '0');
        });

        // 4) Monta o gráfico (Chart.js v2.x)
        var ctx = document.getElementById('barChart').getContext('2d');
        new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
            label: 'Notícias por OE',
            data: counts,
            borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
            yAxes: [{
                ticks: { beginAtZero: true, precision: 0 }
            }],
            xAxes: [{
                ticks: { autoSkip: false } // mostra todas as 24 labels
            }]
            },
            legend: { display: false },
            tooltips: {
            callbacks: {
                label: function (tooltipItem) {
                return ' ' + tooltipItem.yLabel + ' notícia(s)';
                }
            }
            }
        }
        });
    })();
    </script>

      <!-- /. container-fluid -->

      <div class="card-footer button-container">
        <div class="row">

          <div class="col-sm-12 col-md-auto">
            <a href="/monitoramento/">
              <button id="botao-voltar" class="btn btn-info float-left"><svg class="icone-branco" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>&nbsp;&nbsp;Voltar</button>
            </a>
          </div>

          <div class="col-sm-12 col-md">
            <button onclick="gerar_indicadores()" id="botao-cadastrar_doacao" class="btn btn-info float-right" style="margin-right: 15px;"><svg class="icone-branco" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M176 24c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 40c-35.3 0-64 28.7-64 64l-40 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l40 0 0 56-40 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l40 0 0 56-40 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l40 0c0 35.3 28.7 64 64 64l0 40c0 13.3 10.7 24 24 24s24-10.7 24-24l0-40 56 0 0 40c0 13.3 10.7 24 24 24s24-10.7 24-24l0-40 56 0 0 40c0 13.3 10.7 24 24 24s24-10.7 24-24l0-40c35.3 0 64-28.7 64-64l40 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-40 0 0-56 40 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-40 0 0-56 40 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-40 0c0-35.3-28.7-64-64-64l0-40c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 40-56 0 0-40c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 40-56 0 0-40zM160 128l192 0c17.7 0 32 14.3 32 32l0 192c0 17.7-14.3 32-32 32l-192 0c-17.7 0-32-14.3-32-32l0-192c0-17.7 14.3-32 32-32zm192 32l-192 0 0 192 192 0 0-192z"/></svg>&nbsp;&nbsp;Gerar Indicadores com IA</button>
          </div>
        </div>
      </div>

    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
 <!-- /version do sistema -->
 {% include 'footer_version.html' %}
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<!-- jQuery UI 1.11.4 -->
<script src="{% static 'plugins/jquery-ui/jquery-ui.min.js' %}"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- ChartJS -->
<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>
<!-- Sparkline -->
<script src="{% static 'plugins/sparklines/sparkline.js' %}"></script>
<!-- JQVMap -->
<script src="{% static 'plugins/jqvmap/jquery.vmap.min.js' %}"></script>
<script src="{% static 'plugins/jqvmap/maps/jquery.vmap.usa.js' %}"></script>
<!-- jQuery Knob Chart -->
<script src="{% static 'plugins/jquery-knob/jquery.knob.min.js' %}"></script>
<!-- daterangepicker -->
<script src="{% static 'plugins/moment/moment.min.js' %}"></script>
<script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
<!-- Summernote -->
<script src="{% static 'plugins/summernote/summernote-bs4.min.js' %}"></script>
<!-- overlayScrollbars -->
<script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static '/dist/js/adminlte.js' %}"></script>
<!-- Menu Lateral -->
<script src="{% static 'js/menu_lateral.js' %}"></script>

<!-- html2pdf -->
<script src="{% static 'plugins/html2pdf/html2pdf.bundle.min.js' %}"></script>
<!-- jsPDF -->

<!-- dom-to-image -->
<script src="{%static 'plugins/dom-to-image/dom-to-image.min.js' %}"></script>
<!-- Exportar análise-->
<script src="{% static 'js/exportar_campanha.js' %}"></script>

<script>
  active_menu_monitoramento();
</script>

{% url 'atualizar_dashboard_mes' dashboard.id dashboard.month as atualizar_url %}
<script>
async function gerar_indicadores() {
  try {
    const response = await fetch("{{ atualizar_url }}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    });
    const data = await response.json();
    if (data.status === "ok") {
      alert('Indicadores gerados com sucesso.');
      location.reload();
    } else {
      alert(data.message || "Erro ao gerar Indicadores.");
    }
  } catch (error) {
    console.error(error);
    alert("Erro na requisição.");
  }
}
</script>

<!-- ChartJS -->
<script src="{% static 'plugins/chart.js/Chart.min.js' %}"></script>

{{ dashboard.oe_count|default:"[]"|json_script:"oeCountData" }}
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (typeof Chart === 'undefined') {
    console.error('Chart.js não carregado'); return;
  }
  var raw = [];
  try { raw = JSON.parse(document.getElementById('oeCountData').textContent || '[]'); } catch(e) {}

  var counts = Array.from({length: 25}, (_, i) => Number.isFinite(Number(raw[i])) ? Number(raw[i]) : 0);
  var labels = Array.from({length: 25}, (_, i) => 'OE' + String(i+1).padStart(2,'0'));

  var ctx = document.getElementById('barChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Notícias por OE', data: counts, borderWidth: 1 }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        yAxes: [{ ticks: { beginAtZero: true, precision: 0 } }],
        xAxes: [{ ticks: { autoSkip: false } }]
      },
      legend: { display: false }
    }
  });
});
</script>


</body>
</html>
